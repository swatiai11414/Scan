name: H1 Pro Hunter Stealth Scan

on:
  workflow_dispatch:
    inputs:
      ip_list:
        description: 'Paste IPs (Leave EMPTY to use repo ip.txt)'
        required: false 
        type: string
        default: '' 

jobs:
  pro-stealth-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Limit
    
    steps:
      # STEP 1: Repo Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Nmap
        run: sudo apt-get update && sudo apt-get install -y nmap

      - name: Prepare Target List
        run: |
          if [ -n "${{ inputs.ip_list }}" ]; then
            echo "${{ inputs.ip_list }}" > ip.txt
            echo "Using Manual Input IPs."
          elif [ -f ip.txt ]; then
            echo "Using ip.txt from Repository."
          else
            echo "Error: No IP list found."
            exit 1
          fi
          
          echo "Scanning the following targets:"
          cat ip.txt

      - name: Run Pro Bug Hunter Scan
        run: |
          echo "Starting Pro Bug Hunter Scan (TCP Connect + Scripts)..."
          
          PORT_LIST="21,22,23,25,53,80,81,110,111,135,139,143,389,443,445,465,500,587,993,995,1194,1433,1521,2049,2082,2083,2087,2375,27017,3000,3128,3306,3389,3690,4000,4444,4500,5000,5432,5601,5800,5900,6000,6379,6443,7001,8000,8008,8080,8081,8090,8443,8888,9000,9001,9090,9200,9443,10000,10250,11211,27018,50000"

          # SCAN COMMAND EXPLANATION:
          # -sT: TCP Connect scan (Most reliable for GitHub Actions/Cloud)
          # -sV: Detect Service Version
          # -sC: Run default scripts (Grabs HTTP titles, headers, SSL info)
          # -T3: Normal timing (Faster than T2, avoids timeouts)
          # --min-rate 150: Keeps scan moving to prevent stalls
          
          sudo nmap -vv -Pn -sT -sV -sC --version-intensity 5 -T3 --min-rate 150 -n --randomize-hosts -p $PORT_LIST --open -iL ip.txt -oN scan_results.txt || true

          echo "Scan process completed."

      - name: Filter & Show Interesting Findings
        run: |
          if [ -f scan_results.txt ]; then
            echo "--- RAW RESULTS ---"
            # Shows Open ports, Titles, Service Info
            grep -E "open|Nmap scan report|Service Info|_http-title" scan_results.txt || echo "No open ports found in grep filter."
          else
            echo "No results found (scan_results.txt missing)."
          fi

      - name: Save Full Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pro-hunter-report
          path: scan_results.txt
